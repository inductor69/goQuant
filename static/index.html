<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deribit Trading Interface</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        select, input, button { margin: 5px; padding: 5px; }
        #orderbook { display: flex; justify-content: space-around; }
        .orderbook-side { width: 45%; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Deribit Trading Interface</h1>
    
    <select id="marketSelect">
        <option value="">Select a market</option>
    </select>
    <button onclick="subscribeToMarket()">Subscribe</button>
    <button onclick="unsubscribeFromMarket()">Unsubscribe</button>

    <div id="orderbook">
        <div class="orderbook-side">
            <h3>Bids</h3>
            <table id="bidsTable">
                <tr><th>Price</th><th>Amount</th></tr>
            </table>
        </div>
        <div class="orderbook-side">
            <h3>Asks</h3>
            <table id="asksTable">
                <tr><th>Price</th><th>Amount</th></tr>
            </table>
        </div>
    </div>

    <h2>Place Order</h2>
    <select id="orderType">
        <option value="market">Market</option>
        <option value="limit">Limit</option>
    </select>
    <select id="orderSide">
        <option value="buy">Buy</option>
        <option value="sell">Sell</option>
    </select>
    <input id="orderAmount" type="number" step="0.00000001" placeholder="Amount">
    <input id="orderPrice" type="number" step="0.01" placeholder="Price (for limit orders)">
    <button onclick="placeOrder()">Place Order</button>

    <h2>Cancel Order</h2>
    <input id="cancelOrderId" placeholder="Order ID">
    <button onclick="cancelOrder()">Cancel Order</button>

    <h2>Modify Order</h2>
    <input id="modifyOrderId" placeholder="Order ID">
    <input id="modifyAmount" type="number" step="0.00000001" placeholder="New Amount">
    <input id="modifyPrice" type="number" step="0.01" placeholder="New Price">
    <button onclick="modifyOrder()">Modify Order</button>

    <h2>Current Positions</h2>
    <button onclick="viewPositions()">View Positions</button>
    <div id="positions"></div>

    <script>
        const ws = new WebSocket('ws://localhost:8000/ws');
        let currentMarket = '';
        let instrumentInfo = {};

        ws.onopen = () => {
            console.log('Connected to WebSocket server');
            fetchMarkets();
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateOrderbook(data);
        };

        function fetchMarkets() {
            fetch('https://test.deribit.com/api/v2/public/get_instruments?currency=BTC&kind=future')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('marketSelect');
                    data.result.forEach(instrument => {
                        const option = document.createElement('option');
                        option.value = instrument.instrument_name;
                        option.textContent = instrument.instrument_name;
                        select.appendChild(option);
                        
                        // Store instrument info
                        instrumentInfo[instrument.instrument_name] = {
                            contractSize: instrument.contract_size,
                            quoteCurrency: instrument.quote_currency
                        };
                    });
                });
        }

        function subscribeToMarket() {
            const market = document.getElementById('marketSelect').value;
            if (market) {
                currentMarket = market;
                ws.send(JSON.stringify({ action: 'subscribe', instrument: market }));
            }
        }

        function unsubscribeFromMarket() {
            if (currentMarket) {
                ws.send(JSON.stringify({ action: 'unsubscribe', instrument: currentMarket }));
                currentMarket = '';
                clearOrderbook();
            }
        }

        function updateOrderbook(data) {
            const bidsTable = document.getElementById('bidsTable');
            const asksTable = document.getElementById('asksTable');
            
            // Clear previous data
            bidsTable.innerHTML = '<tr><th>Price</th><th>Amount</th></tr>';
            asksTable.innerHTML = '<tr><th>Price</th><th>Amount</th></tr>';

            // Update bids
            data.bids.forEach(bid => {
                const row = bidsTable.insertRow(-1);
                row.insertCell(0).textContent = bid[0];
                row.insertCell(1).textContent = bid[1];
            });

            // Update asks
            data.asks.forEach(ask => {
                const row = asksTable.insertRow(-1);
                row.insertCell(0).textContent = ask[0];
                row.insertCell(1).textContent = ask[1];
            });
        }

        function clearOrderbook() {
            document.getElementById('bidsTable').innerHTML = '<tr><th>Price</th><th>Amount</th></tr>';
            document.getElementById('asksTable').innerHTML = '<tr><th>Price</th><th>Amount</th></tr>';
        }

        async function placeOrder() {
            const symbol = document.getElementById('marketSelect').value;
            const orderType = document.getElementById('orderType').value;
            const side = document.getElementById('orderSide').value;
            const amount = parseFloat(document.getElementById('orderAmount').value);
            const price = document.getElementById('orderPrice').value ? parseFloat(document.getElementById('orderPrice').value) : null;

            if (!symbol) {
                alert('Please select a market');
                return;
            }

            if (!amount) {
                alert('Please enter an amount');
                return;
            }

            if (orderType === 'limit' && !price) {
                alert('Please enter a price for limit orders');
                return;
            }

            // Check if amount is a multiple of contract size
            const contractSize = instrumentInfo[symbol].contractSize;
            if (amount % contractSize !== 0) {
                alert(`Amount must be a multiple of the contract size (${contractSize})`);
                return;
            }

            const orderData = {
                symbol: symbol,
                type: orderType,
                side: side,
                amount: amount,
                price: price
            };

            try {
                const response = await fetch('http://localhost:8000/place_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData),
                });

                const result = await response.json();
                console.log('Order response:', result);
                
                if (result.error) {
                    let errorMessage = `Error placing order:\n`;
                    errorMessage += `Message: ${result.error.message}\n`;
                    errorMessage += `Code: ${result.error.code}\n`;
                    if (result.error.data) {
                        errorMessage += `Param: ${result.error.data.param}\n`;
                        errorMessage += `Reason: ${result.error.data.reason}\n`;
                    }
                    alert(errorMessage);
                } else if (result.result) {
                    let message = 'Order placed successfully:\n';
                    message += `Order ID: ${result.result.order.order_id}\n`;
                    message += `Price: ${result.result.order.price}\n`;
                    message += `Amount: ${result.result.order.amount}\n`;
                    message += `Order State: ${result.result.order.order_state}\n`;
                    message += `Contract Size: ${contractSize} ${instrumentInfo[symbol].quoteCurrency}\n`;
                    const totalValue = result.result.order.amount * contractSize;
                    message += `Total Value: ${totalValue} ${instrumentInfo[symbol].quoteCurrency}\n`;
                    alert(message);
                }
            } catch (error) {
                console.error('Error placing order:', error);
                alert(`Error placing order: ${error.message}`);
            }
        }

        async function cancelOrder() {
            const orderId = document.getElementById('cancelOrderId').value;
            const symbol = document.getElementById('marketSelect').value;

            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }

            if (!symbol) {
                alert('Please select a market');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/cancel_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: orderId, symbol: symbol }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to cancel order');
                }

                const result = await response.json();
                console.log('Order cancelled:', result);
                alert('Order cancelled successfully');
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert(`Error cancelling order: ${error.message}`);
            }
        }

        async function modifyOrder() {
            const orderId = document.getElementById('modifyOrderId').value;
            const symbol = document.getElementById('marketSelect').value;
            const newAmount = document.getElementById('modifyAmount').value;
            const newPrice = document.getElementById('modifyPrice').value;

            if (!orderId) {
                alert('Please enter an Order ID');
                return;
            }

            if (!symbol) {
                alert('Please select a market');
                return;
            }

            if (!newAmount && !newPrice) {
                alert('Please enter a new amount or price');
                return;
            }

            const modifyData = {
                id: orderId,
                symbol: symbol,
                amount: newAmount ? parseFloat(newAmount) : undefined,
                price: newPrice ? parseFloat(newPrice) : undefined
            };

            try {
                const response = await fetch('http://localhost:8000/modify_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(modifyData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to modify order');
                }

                const result = await response.json();
                console.log('Order modified:', result);
                alert('Order modified successfully');
            } catch (error) {
                console.error('Error modifying order:', error);
                alert(`Error modifying order: ${error.message}`);
            }
        }

        async function viewPositions() {
            try {
                const response = await fetch('http://localhost:8000/get_positions');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to fetch positions');
                }
                const result = await response.json();
                console.log('Positions:', result);
                document.getElementById('positions').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                console.error('Error fetching positions:', error);
                document.getElementById('positions').textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>